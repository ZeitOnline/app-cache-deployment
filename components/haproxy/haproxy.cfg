# Generated by batou app-cache-deployment. Do not edit.

global
  daemon
  user haproxy
  group haproxy
  stats socket /var/run/haproxy.sock user haproxy group {{component.environment.service_user}} mode 0775 level admin
  log /dev/log local0
  maxconn 4096

resolvers dns
    {%- for nameserver in component.nameservers %}
    nameserver nameserver_{{loop.index}} {{nameserver}}:53
    {%- endfor %}
    hold valid 300s


defaults
  mode http
  balance leastconn

  log global
  option httplog
  option dontlognull

  option abortonclose
  option clitcpka
  option srvtcpka
  option tcpka
  option contstats
  option forwardfor

  timeout check 5s
  timeout client 15s
  timeout connect 5s
  timeout server 60s

  retries 0

  default-server resolve-prefer ipv4 ca-file /etc/ssl/certs/ca-certificates.crt


backend haproxy-stats
  stats uri /haproxy/stats
  stats refresh 5s
  stats show-node
  stats hide-version


frontend memcache
    mode tcp
    timeout client 1h
    bind 0.0.0.0:{{component.memcache_port}}
    default_backend memcache

backend memcache
    mode tcp
    balance roundrobin
    {%- for host in component.varnish_hosts %}
    server {{host}} {{host}}:11211 check {{component.memcache_settings[loop.index0]}}
    {%- endfor %}


frontend ingress
    bind 0.0.0.0:80

    # Only internal services will ever be allowed to use this service
    acl zeit_networks src {{component.zeit_networks | join(' ')}}
    http-request deny if !zeit_networks

    acl url_haproxy_stats  path_beg /haproxy/stats
    use_backend haproxy-stats if url_haproxy_stats

    acl host_c1 hdr(host) -i livecrm-front{{component.subdomain}}.zeit.de
    use_backend c1 if host_c1

    # Compatibility for zeit-metrics::varnishlog
    http-request add-header X-ZON-Edge-IP %ci

    capture request header Referer len 100
    capture request header User-Agent len 150

    default_backend varnish

backend varnish
    balance roundrobin
    fullconn 40000
    option forwardfor
    option httpchk GET /cache_health HTTP/1.0
    http-check expect rstring OK
    {%- for host in component.varnish_hosts %}
    server {{host}} {{host}}:8080 check inter 5s fastinter 1s rise 2 fall 3
    {%- endfor %}

backend c1  # used by zeit.accounts
  option forwardfor
  option httpchk GET /probe_status HTTP/1.0
  http-check expect rstring OK
  server livecrm-front01 livecrm-front01{{component.subdomain}}.zeit.de:80 weight 50 check inter 10s fastinter 5s rise 2 fall 3
  server livecrm-front02 livecrm-front02{{component.subdomain}}.zeit.de:80 weight 50 check inter 10s fastinter 5s rise 2 fall 3


frontend app-cache
    bind 0.0.0.0:8081

    acl host_brandeins_feed hdr(host) -i www.brandeins.de
    acl url_brandeins_feed path_beg /zeit-feed.rss
    use_backend brandeins_feed if host_brandeins_feed url_brandeins_feed

    acl host_community_app hdr(host) -i community-app{{component.subdomain}}.zeit.de
    use_backend community_app if host_community_app

    acl host_spektrum_feed hdr(host) -i www.spektrum.de
    acl url_spektrum_feed path_beg /alias/rss/zeit-kooperationsfeed-mit-kategorien/1342995
    use_backend spektrum_feed if host_spektrum_feed url_spektrum_feed

    acl host_academics hdr(host) -i jobs.zeit.de
    acl url_academics_feed path_beg /cached-rss-feeds/adpanel_333644.html
    use_backend academics_feed if host_academics url_academics_feed

    acl host_cardstack hdr_beg(host) -i card-builder-zon.lovely-cdn.com
    use_backend cardstack if host_cardstack

    acl url_liveblog_2_content path_beg -i /liveblog/2/content
    use_backend liveblog_2_content if url_liveblog_2_content

    acl url_liveblog_2_api path_beg -i /liveblog/2/api
    use_backend liveblog_2_api if url_liveblog_2_api

    acl url_liveblog_3_content path_beg -i /liveblog/3/content
    use_backend liveblog_3_content if url_liveblog_3_content

    acl url_liveblog_3_api path_beg -i /liveblog/3/api
    use_backend liveblog_3_api if url_liveblog_3_api

    acl url_liveblog_staging_content path_beg -i /liveblog/staging/content
    use_backend liveblog_staging_content if url_liveblog_staging_content

    acl url_liveblog_staging_api path_beg -i /liveblog/staging/api
    use_backend liveblog_staging_api if url_liveblog_staging_api

    acl host_zett_feed hdr(host) -i ze.tt
    acl url_zett_feed path_beg /feed-zon
    use_backend zett_feed if host_zett_feed url_zett_feed


backend brandeins_feed
    option httpchk GET /zeit-feed.rss HTTP/1.1\r\nHost:\ www.brandeins.de
    server www.brandeins.de www.brandeins.de:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend community_app
    option httpchk GET /agatho/health_check HTTP/1.1\r\nHost:\ community{{component.subdomain}}.zeit.de
    server community-app01{{component.subdomain}}.zeit.de community-app01{{component.subdomain}}.zeit.de:80 check inter 10s fastinter 5s rise 2 fall 3

# Currently unavailable because it was not part of their relaunch MVP
backend academics_feed
    # option httpchk GET /cached-rss-feeds/adpanel_333644.html HTTP/1.1\r\nHost:\ jobs.zeit.de
    # server jobs.zeit.de jobs.zeit.de:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend spektrum_feed
    option httpchk GET /alias/rss/zeit-kooperationsfeed-mit-kategorien/1342995 HTTP/1.1\r\nHost:\ www.spektrum.de
    server www.spektrum.de www.spektrum.de:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend cardstack
    option httpchk GET /images/loading.gif HTTP/1.1\r\nHost:\ card-builder-zon.lovely-cdn.com
    server card-builder-zon.lovely-cdn.com card-builder-zon.lovely-cdn.com:443 ssl resolvers dns check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_2_content
    option httpchk GET /resources/LiveDesk/Blog HTTP/1.1\r\nHost:\ zeit.superdesk.pro
    http-request set-header Host zeit.superdesk.pro
    http-request set-path %[path,regsub(^/liveblog/2/content/health-check,/resources/LiveDesk/Blog)]
    http-request set-path %[path,regsub(^/liveblog/2/content,/content/seo)]
    server zeit.superdesk.pro zeit.superdesk.pro:80 resolvers dns check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_2_api
    option httpchk GET /resources/LiveDesk/Blog HTTP/1.1\r\nHost:\ zeit.superdesk.pro
    http-request set-header Host zeit.superdesk.pro
    http-request set-path %[path,regsub(^/liveblog/2/api,/resources/LiveDesk)]
    server zeit.superdesk.pro zeit.superdesk.pro:80 resolvers dns check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_3_content
    option httpchk GET / HTTP/1.1\r\nHost:\ zeit.liveblog.pro
    http-request set-header Host zeit.liveblog.pro
    http-request set-path %[path,regsub(^/liveblog/3/content/health-check,/zeit/blogs/5a1ecb356aa4f500ed9fb5bc/index.html)]
    http-request set-path %[path,regsub(^/liveblog/3/content,/zeit/blogs)]
    server zeit.liveblog.pro zeit.liveblog.pro:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_3_api
    option httpchk GET /api HTTP/1.1\r\nHost:\ zeit-api.liveblog.pro
    http-request set-header Host zeit-api.liveblog.pro
    http-request set-path %[path,regsub(^/liveblog/3/api,/api)]
    server zeit-api.liveblog.pro zeit-api.liveblog.pro:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_staging_content
    option httpchk GET /lb-release350/blogs/5c347bd7f077cc00e846fc96/index.html HTTP/1.1\r\nHost:\ superdesk-test.s3-eu-west-1.amazonaws.com
    http-request set-header Host superdesk-test.s3-eu-west-1.amazonaws.com
    http-request set-path %[path,regsub(^/liveblog/staging/content/health-check,/lb-release350/blogs/5c347bd7f077cc00e846fc96/index.html)]
    http-request set-path %[path,regsub(^/liveblog/staging/content,/lb-release350/blogs)]
    server superdesk-test.s3-eu-west-1.amazonaws.com superdesk-test.s3-eu-west-1.amazonaws.com:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_staging_api
    option httpchk GET /api HTTP/1.1\r\nHost:\ lb-release350.test.superdesk.org
    http-request set-header Host lb-release350.test.superdesk.org
    http-request set-path %[path,regsub(^/liveblog/staging/api,/api)]
    server lb-release350.test.superdesk.org lb-release350.test.superdesk.org:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend zett_feed
    option httpchk GET /feed-zon HTTP/1.1\r\nHost:\ ze.tt
    server ze.tt ze.tt:443 ssl check inter 60s fastinter 10s rise 2 fall 3
