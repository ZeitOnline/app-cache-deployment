# Generated by batou app-cache-deployment. Do not edit.

global
  daemon
  user haproxy
  group haproxy
  stats socket /var/run/haproxy.sock user haproxy group {{component.environment.service_user}} mode 0775 level admin
  log /dev/log local0
  maxconn 4096

  # https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy (`intermediate`)
  tune.ssl.default-dh-param 2048

  ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
  ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets

  ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
  ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets


resolvers dns
    {%- for nameserver in component.nameservers %}
    nameserver nameserver_{{loop.index}} {{nameserver}}:53
    {%- endfor %}
    hold valid 300s


defaults
  mode http
  balance leastconn

  log global
  option httplog
  option dontlognull

  option abortonclose
  option clitcpka
  option srvtcpka
  option tcpka
  option contstats
  option forwardfor

  timeout check 5s
  timeout client 15s
  timeout connect 5s
  timeout server 60s

  retries 0

  default-server resolvers dns resolve-prefer ipv4 ca-file /etc/ssl/certs/ca-certificates.crt


backend haproxy-stats
  stats uri /haproxy/stats
  stats refresh 5s
  stats show-node
  stats hide-version


frontend memcache
    mode tcp
    timeout client 1h
    bind 0.0.0.0:{{component.memcache_port}}
    default_backend memcache

backend memcache
    mode tcp
    balance roundrobin
    {%- for host in component.varnish_hosts %}
    server {{host}} {{host}}:11211 check {{component.memcache_settings[loop.index0]}}
    {%- endfor %}


frontend ingress
    bind 0.0.0.0:80
    {% if component.ssl_cert %}
    bind 0.0.0.0:443 ssl crt {{component.ssl_cert}}
    {% endif %}

    # Only internal services will ever be allowed to use this service
    acl zeit_networks src {{component.zeit_networks | join(' ')}}
    http-request deny if !zeit_networks

    acl url_haproxy_stats  path_beg /haproxy/stats
    use_backend haproxy-stats if url_haproxy_stats

    acl host_c1 hdr(host) -i livecrm-front{{component.subdomain}}.zeit.de
    use_backend c1 if host_c1

    # used by ZOCA
    acl host_community hdr_beg(host) -i community-app{{component.subdomain}}.zeit.de
    use_backend community_app if host_community

    # used by datascience.zeit.de
    acl path_c1 path_beg -i /livecrm-front
    use_backend c1_datascience if path_c1

    # Compatibility for zeit-metrics::varnishlog
    http-request add-header X-ZON-Edge-IP %ci

    capture request header Referer len 100
    capture request header User-Agent len 150

    default_backend varnish

backend varnish
    balance roundrobin
    fullconn 40000
    option forwardfor
    option httpchk GET /cache_health HTTP/1.0
    http-check expect rstring OK
    {%- for host in component.varnish_hosts %}
    server {{host}} {{host}}:8080 check inter 5s fastinter 1s rise 2 fall 3
    {%- endfor %}

backend c1  # used by zeit.accounts
  option forwardfor
  option httpchk GET /probe_status HTTP/1.0
  http-check expect rstring OK
  server livecrm-front01 livecrm-front01{{component.subdomain}}.zeit.de:80 weight 50 check inter 10s fastinter 5s rise 2 fall 3
  server livecrm-front02 livecrm-front02{{component.subdomain}}.zeit.de:80 weight 50 check inter 10s fastinter 5s rise 2 fall 3


backend c1_datascience  # used by datascience.zeit.de
  option forwardfor
  option httpchk GET /probe_status HTTP/1.0
  http-check expect rstring OK
  http-request set-path %[path,regsub(^/livecrm-front,/)]
  server livecrm-front01 livecrm-front01{{component.subdomain}}.zeit.de:80 weight 50 check inter 10s fastinter 5s rise 2 fall 3
  server livecrm-front02 livecrm-front02{{component.subdomain}}.zeit.de:80 weight 50 check inter 10s fastinter 5s rise 2 fall 3


frontend app-cache
    bind 0.0.0.0:8081

    # used by front-varnish
    acl url_cardstack path_beg -i /cardstack
    use_backend cardstack if url_cardstack
    # BBB
    acl host_cardstack hdr_beg(host) -i card-builder-zon.lovely-cdn.com
    use_backend cardstack if host_cardstack

    # liveblogs, api used by app-cache, content used by front-varnish
    acl url_liveblog_2_content path_beg -i /liveblog/2/content
    use_backend liveblog_2_content if url_liveblog_2_content

    acl url_liveblog_2_api path_beg -i /liveblog/2/api
    use_backend liveblog_2_api if url_liveblog_2_api

    acl url_liveblog_3_content path_beg -i /liveblog/3/content
    use_backend liveblog_3_content if url_liveblog_3_content

    acl url_liveblog_3_api path_beg -i /liveblog/3/api
    use_backend liveblog_3_api if url_liveblog_3_api

    acl url_liveblog_staging_content path_beg -i /liveblog/staging/content
    use_backend liveblog_staging_content if url_liveblog_staging_content

    acl url_liveblog_staging_api path_beg -i /liveblog/staging/api
    use_backend liveblog_staging_api if url_liveblog_staging_api

    # HP feeds, used by app-cache varnish
    acl url_academics path_beg /hp-feed/academics
    use_backend academics if url_academics

    acl url_brandeins path_beg /hp-feed/brandeins
    use_backend brandeins if url_brandeins

    acl url_zett path_beg /hp-feed/zett
    use_backend zett if url_zett

    # community, used by app-cache varnish
    acl url_community path_beg /agatho
    use_backend community_app if url_community

backend brandeins
    option httpchk GET /zeit-feed.rss HTTP/1.1\r\nHost:\ www.brandeins.de
    http-request set-header Host www.brandeins.de
    http-request set-path %[path,regsub(^/hp-feed/brandeins,/zeit-feed.rss)]
    server www.brandeins.de www.brandeins.de:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend community_app
    option httpchk GET /agatho/health_check HTTP/1.1\r\nHost:\ community{{component.subdomain}}.zeit.de
    http-request set-header Host community{{component.subdomain}}.zeit.de
    server community-app01{{component.subdomain}}.zeit.de community-app01{{component.subdomain}}.zeit.de:80 check inter 10s fastinter 5s rise 2 fall 3

# Currently unavailable because it was not part of their relaunch MVP
backend academics
    # option httpchk GET /cached-rss-feeds/adpanel_333644.html HTTP/1.1\r\nHost:\ jobs.zeit.de
    # http-request set-header Host jobs.zeit.de
    # http-request set-path %[path,regsub(^/hp-feed/academics,/cached-rss-feeds/adpanel_333644.html)]
    # server jobs.zeit.de jobs.zeit.de:443 ssl check inter 10s fastinter 5s rise 2 fall 3

backend zett
    option httpchk GET /feed-zon HTTP/1.1\r\nHost:\ ze.tt
    http-request set-header Host ze.tt
    http-request set-path %[path,regsub(^/hp-feed/zett,/feed-zon)]
    server ze.tt ze.tt:443 ssl check-sni ze.tt check inter 60s fastinter 10s rise 2 fall 3

backend cardstack
    option httpchk GET /images/loading.gif HTTP/1.1\r\nHost:\ card-builder-zon.lovely-cdn.com
    http-request set-header Host card-builder-zon.lovely-cdn.com
    http-request set-path %[path,regsub(^/cardstack/health-check,/images/loading.gif)]
    http-request set-path %[path,regsub(^/cardstack,)]
    server card-builder-zon.lovely-cdn.com card-builder-zon.lovely-cdn.com:443 ssl sni str(card-builder-zon.lovely-cdn.com) check-sni card-builder-zon.lovely-cdn.com check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_2_content
    option httpchk GET /resources/LiveDesk/Blog HTTP/1.1\r\nHost:\ zeit.superdesk.pro
    http-request set-header Host zeit.superdesk.pro
    http-request set-path %[path,regsub(^/liveblog/2/content/health-check,/resources/LiveDesk/Blog)]
    http-request set-path %[path,regsub(^/liveblog/2/content,/content/seo)]
    server zeit.superdesk.pro zeit.superdesk.pro:443 ssl sni str(zeit.superdesk.pro) check-sni zeit.superdesk.pro check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_2_api
    option httpchk GET /resources/LiveDesk/Blog HTTP/1.1\r\nHost:\ zeit.superdesk.pro
    http-request set-header Host zeit.superdesk.pro
    http-request set-path %[path,regsub(^/liveblog/2/api,/resources/LiveDesk)]
    server zeit.superdesk.pro zeit.superdesk.pro:443 ssl sni str(zeit.superdesk.pro) check-sni zeit.superdesk.pro check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_3_content
    option httpchk GET / HTTP/1.1\r\nHost:\ zeit.liveblog.pro
    http-request set-header Host zeit.liveblog.pro
    http-request set-path %[path,regsub(^/liveblog/3/content/health-check,/zeit/blogs/5a1ecb356aa4f500ed9fb5bc/index.html)]
    http-request set-path %[path,regsub(^/liveblog/3/content,/zeit/blogs)]
    server zeit.liveblog.pro zeit.liveblog.pro:443 ssl sni str(zeit.liveblog.pro) check-sni zeit-api.liveblog.pro check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_3_api
    option httpchk GET /api HTTP/1.1\r\nHost:\ zeit-api.liveblog.pro
    http-request set-header Host zeit-api.liveblog.pro
    http-request set-path %[path,regsub(^/liveblog/3/api,/api)]
    server zeit-api.liveblog.pro zeit-api.liveblog.pro:443 ssl sni str(zeit-api.liveblog.pro) check-sni zeit-api.liveblog.pro check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_staging_content
    option httpchk GET /lb-test/blogs/5dd3ff3dbed0ef4d2e7edb0c/index.html HTTP/1.1\r\nHost:\ test.liveblog.pro
    http-request set-header Host test.liveblog.pro
    http-request set-path %[path,regsub(^/liveblog/staging/content/health-check,/lb-test/blogs/5dd3ff3dbed0ef4d2e7edb0c/index.html)]
    http-request set-path %[path,regsub(^/liveblog/staging/content,/lb-test/blogs)]
    server test.liveblog.pro test.liveblog.pro:443 ssl sni str(test.liveblog.pro) check-sni test.liveblog.pro check inter 10s fastinter 5s rise 2 fall 3

backend liveblog_staging_api
    option httpchk GET /api HTTP/1.1\r\nHost:\ test-api.liveblog.pro
    http-request set-header Host test-api.liveblog.pro
    http-request set-path %[path,regsub(^/liveblog/staging/api,/api)]
    server test-api.liveblog.pro test-api.liveblog.pro:443 ssl sni str(test-api.liveblog.pro) check-sni test-api.liveblog.pro check inter 10s fastinter 5s rise 2 fall 3
