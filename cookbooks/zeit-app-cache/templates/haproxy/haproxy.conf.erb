# Generated by chef zeit-web::app-cache.zeit.de. Do not edit.

global
    daemon
    user haproxy
    group haproxy
    log 127.0.0.1 local1
    maxconn 400000
    stats socket /var/run/haproxy.sock user haproxy group adm mode 0775 level admin

resolvers dns
    nameserver gaertner1 217.13.69.1:53
    nameserver gaertner2 217.13.69.2:53
    nameserver gaertner3 217.13.69.3:53
    hold valid 300s

defaults
    log global
    option abortonclose
    option dontlognull
    timeout check 5s
    timeout client 15s
    timeout connect 5s
    timeout server 60s
    retries 0
    mode http

frontend app-cache
    bind 0.0.0.0:80

    acl url_haproxy_stats  path_beg /haproxy/stats
    use_backend haproxy-stats if url_haproxy_stats

    acl host_brandeins_feed hdr(host) -i www.brandeins.de
    acl url_brandeins_feed path_beg /zeit-feed.rss
    use_backend brandeins_feed if host_brandeins_feed url_brandeins_feed

    acl host_cardstack hdr_beg(host) -i card-builder-zon.lovely-cdn.com
    use_backend cardstack if host_cardstack

    acl host_liveblog hdr_beg(host) -i zeit.superdesk.pro
    use_backend liveblog if host_liveblog

    acl host_liveblog3 hdr_beg(host) -i zeit.liveblog.pro
    use_backend liveblog3 if host_liveblog3

    acl host_liveblog3api hdr_beg(host) -i zeit-api.liveblog.pro
    use_backend liveblog3api if host_liveblog3api

    acl host_zett_feed hdr(host) -i ze.tt
    acl url_zett_feed path_beg /feed-zon
    use_backend zett_feed if host_zett_feed url_zett_feed

    option httplog
    capture request header Referer len 100
    capture request header User-Agent len 150

    default_backend varnish

backend varnish
    balance roundrobin
    fullconn 40000
    option forwardfor
    option httpchk GET /cache_health HTTP/1.0
    http-check expect rstring OK
    server app-cache01 app-cache01.zeit.de:8080 check inter 5s fastinter 1s rise 2 fall 3
    server app-cache02 app-cache02.zeit.de:8080 check inter 5s fastinter 1s rise 2 fall 3

backend brandeins_feed
    option httpchk GET /zeit-feed.rss HTTP/1.1\r\nHost:\ www.brandeins.de
    server www.brandeins.de www.brandeins.de:443 check ssl verify none inter 10s fastinter 5s rise 2 fall 3

backend cardstack
    option httpchk GET /images/loading.gif HTTP/1.1\r\nHost:\ card-builder-zon.lovely-cdn.com
    server card-builder-zon.lovely-cdn.com card-builder-zon.lovely-cdn.com:80 resolvers dns check inter 10s fastinter 5s rise 2 fall 3

backend liveblog
    option httpchk GET /resources/LiveDesk/Blog HTTP/1.1\r\nHost:\ zeit.superdesk.pro
    server zeit.superdesk.pro zeit.superdesk.pro:80 resolvers dns resolve-prefer ipv4 check inter 10s fastinter 5s rise 2 fall 3

backend liveblog3
    option httpchk GET / HTTP/1.1\r\nHost:\ zeit.liveblog.pro
    server zeit.liveblog.pro zeit.liveblog.pro:80 check inter 10s fastinter 5s rise 2 fall 3

backend liveblog3api
    option httpchk GET / HTTP/1.1\r\nHost:\ zeit-api.liveblog.pro
    server zeit-api.liveblog.pro zeit-api.liveblog.pro:80 check inter 10s fastinter 5s rise 2 fall 3

backend zett_feed
    option httpchk GET /feed-zon HTTP/1.1\r\nHost:\ ze.tt
    server ze.tt ze.tt:443 check ssl verify none inter 60s fastinter 10s rise 2 fall 3

backend haproxy-stats
    stats uri /haproxy/stats
    stats refresh 5s
    stats show-node
    stats hide-version

    acl zeit_networks src 194.77.156.0/23 217.13.68.0/24 217.13.66.64/26
    acl restricted_pages path_beg /haproxy/stats
    stats http-request deny if restricted_pages !zeit_networks
